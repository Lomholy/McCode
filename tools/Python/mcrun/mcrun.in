#!/usr/bin/env bash
# Wrapper script for @P@run-py

TOOL="@P@run"

if [[ @MCCODE_LEGACY_PATHS@ == 1 ]]; then
  # First ensure that we follow symlink if needed
  LINK=`readlink $0`

  # Am I a symlink?
  if [ "x$LINK" != "x" ]; then
      TOOLDIR=`dirname $LINK`
  else
      TOOLDIR=`dirname $0`
  fi
  #FIXME: Weird that ../../ is needed here??
  TOOLDIR="${TOOLDIR}/../../"
else
  TOOLDIR="@CMAKE_INSTALL_PREFIX@/@DEST_BINDIR@"
fi

TOOLDIR="${TOOLDIR}/../@DEST_TOOLDIR@/Python/$TOOL"

# Check if we are in / - in that case cd to $HOME
PW==`pwd`
if [[ ${PWD} = / ]]; then
    cd $HOME
fi

# FIXME: embedded conda -> embedded mcstas+tools
if [ -d "$TOOLDIR/../miniconda3" ]; then
    source $TOOLDIR/../miniconda3/bin/activate base
fi
# FIXME: NCrystal should be used via own package/infrastructure
if [ -d "$LIB/share/NCrystal/python/" ]; then
    export PYTHONPATH=$LIB/share/NCrystal/python/:$PYTHONPATH
fi

echo mcrun.py is supposed to reside in $TOOLDIR/mcrun.py

ARCH=`arch`
UNAME=`uname -s`

LIB="$TOOLDIR"
VERS="@MCCODE_VERSION@"


canrun() {
    if ! [ -x ${LIB}/${TOOL}.py ]; then
        exit 127;
    fi

    modules="yaml"
    cmd=""
    for name in ${modules}; do
        cmd="${cmd}import ${name}; "
    done
    python3 -c "${cmd}"
}

if ( canrun ); then
    python3 -u ${LIB}/${TOOL}.py "$@"
else
    @FLAVOR@_errmsg Failed to run Python ${TOOL} - permissions or missing dependencies\?
fi
